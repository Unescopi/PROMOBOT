const app = require('./app');
const evolutionApiService = require('./services/evolutionApiService');
const queueService = require('./services/queueService');
const os = require('os');
const mongoose = require('mongoose');
const { checkRedisConnection } = require('./utils/redisCheck');
const socketService = require('./services/socketService');
require('dotenv').config();

// Logo ASCII do PromoBot
const promobotLogo = `
 \x1b[34m____                            ____        _   
|  _ \\ _ __ ___  _ __ ___   ___ | __ )  ___ | |_ 
| |_) | '__/ _ \\| '_ \` _ \\ / _ \\|  _ \\ / _ \\| __|
|  __/| | | (_) | | | | | | (_) | |_) | (_) | |_ 
|_|   |_|  \\___/|_| |_| |_|\\___/|____/ \\___/ \\__|\x1b[0m
                                                 
 \x1b[32m+-----------------+
 |      .---.      |
 |     /     \\     |
 |    | () () |    |
 |     \\  =  /     |
 |      '---'      |
 |                 |
 | +-+-+-+-+-+-+-+ |
 | |P|R|O|M|O|B|O|T|
 | +-+-+-+-+-+-+-+ |
 +-----------------+\x1b[0m
`;

// Exibir logo antes de tudo
console.log(promobotLogo);

const PORT = process.env.PORT || 3000;

/**
 * Verifica o status dos servi√ßos principais e imprime logs detalhados
 */
async function checkServices() {
  console.log('\n==================================================');
  console.log('ü§ñ PROMOBOT - Sistema de Automa√ß√£o de Mensagens ü§ñ');
  console.log('==================================================\n');
  
  // Informa√ß√µes do sistema
  console.log('üìä INFORMA√á√ïES DO SISTEMA:');
  console.log(`‚Ä¢ Sistema Operacional: ${os.platform()} ${os.release()}`);
  console.log(`‚Ä¢ Arquitetura: ${os.arch()}`);
  console.log(`‚Ä¢ Node.js: ${process.version}`);
  console.log(`‚Ä¢ Vers√µes: ${JSON.stringify({
    node: process.versions.node,
    v8: process.versions.v8,
    npm: process.env.npm_config_node_version || 'desconhecido'
  })}`);
  console.log(`‚Ä¢ Mem√≥ria Total: ${Math.round(os.totalmem() / (1024 * 1024 * 1024))} GB`);
  console.log(`‚Ä¢ Mem√≥ria Livre: ${Math.round(os.freemem() / (1024 * 1024 * 1024))} GB (${Math.round((os.freemem() / os.totalmem()) * 100)}%)`);
  console.log(`‚Ä¢ CPUs: ${os.cpus().length} n√∫cleos`);
  console.log(`‚Ä¢ Ambiente: ${process.env.NODE_ENV || 'development'}`);
  console.log(`‚Ä¢ Diret√≥rio de execu√ß√£o: ${process.cwd()}`);
  console.log(`‚Ä¢ Uptime do sistema: ${Math.floor(os.uptime() / 60 / 60)} horas ${Math.floor((os.uptime() / 60) % 60)} minutos`);
  
  // Verificar status do MongoDB
  console.log('\nüìä STATUS DO BANCO DE DADOS:');
  const mongoState = mongoose.connection.readyState;
  let stateStr = '';
  
  switch (mongoState) {
    case 0:
      stateStr = '‚ùå Desconectado';
      break;
    case 1:
      stateStr = '‚úÖ Conectado';
      break;
    case 2:
      stateStr = 'üîÑ Conectando...';
      break;
    case 3:
      stateStr = 'üîÑ Desconectando...';
      break;
    default:
      stateStr = '‚ùì Desconhecido';
  }
  
  console.log(`‚Ä¢ Estado: ${stateStr}`);
  
  if (mongoState === 1) {
    console.log(`‚Ä¢ Host: ${mongoose.connection.host}`);
    console.log(`‚Ä¢ Banco: ${mongoose.connection.name}`);
    console.log(`‚Ä¢ URL: ${process.env.MONGODB_URI?.replace(/\/\/(.+?):(.+?)@/, '//***:***@') || 'n√£o dispon√≠vel'}`);
    try {
      const collections = await mongoose.connection.db.listCollections().toArray();
      console.log(`‚Ä¢ Cole√ß√µes: ${collections.length} dispon√≠veis`);
      
      // Agrupar cole√ß√µes por tipo
      const appCollections = collections.filter(c => !c.name.startsWith('system.')).map(c => c.name);
      console.log(`‚Ä¢ Cole√ß√µes da aplica√ß√£o (${appCollections.length}):`);
      
      // Dividir em grupos para melhor legibilidade
      const chunks = [];
      for (let i = 0; i < appCollections.length; i += 5) {
        chunks.push(appCollections.slice(i, i + 5));
      }
      
      chunks.forEach(chunk => {
        console.log(`  - ${chunk.join(', ')}`);
      });
      
      // Verificar cole√ß√µes necess√°rias
      const requiredCollections = [
        'contacts', 
        'messages', 
        'campaigns', 
        'messagestatuses',
        'users',
        'tags'
      ];
      
      const missingCollections = requiredCollections.filter(
        collection => !appCollections.includes(collection)
      );
      
      if (missingCollections.length > 0) {
        console.warn(`‚ö†Ô∏è ATEN√á√ÉO: Algumas cole√ß√µes necess√°rias n√£o foram encontradas: ${missingCollections.join(', ')}`);
        console.warn('‚Ä¢ Isso pode indicar que o banco de dados n√£o foi inicializado corretamente ou nomes foram alterados.');
        console.warn('‚Ä¢ As cole√ß√µes ser√£o criadas automaticamente quando necess√°rio.');
      }
      
      // Estat√≠sticas do servidor MongoDB se dispon√≠vel
      try {
        const serverStatus = await mongoose.connection.db.admin().serverStatus();
        console.log(`‚Ä¢ MongoDB vers√£o: ${serverStatus.version}`);
        console.log(`‚Ä¢ Conex√µes ativas: ${serverStatus.connections.current} (max: ${serverStatus.connections.available})`);
        console.log(`‚Ä¢ Uptime do MongoDB: ${Math.floor(serverStatus.uptime / 60 / 60)} horas ${Math.floor((serverStatus.uptime / 60) % 60)} minutos`);
      } catch (err) {
        // Admin pode n√£o estar dispon√≠vel para usu√°rios sem privil√©gios
        console.log('‚Ä¢ Estat√≠sticas do servidor MongoDB n√£o dispon√≠veis (requer privil√©gios de admin)');
      }
    } catch (err) {
      console.log('‚Ä¢ Erro ao listar cole√ß√µes do MongoDB');
      console.error(`  - ${err.message}`);
    }
  } else {
    console.error('‚ùå MongoDB n√£o est√° conectado corretamente');
    console.error(`‚Ä¢ Verifique a URL de conex√£o: ${process.env.MONGODB_URI?.replace(/\/\/(.+?):(.+?)@/, '//***:***@') || 'n√£o definida'}`);
    console.error('‚Ä¢ Certifique-se de que o servidor MongoDB est√° rodando e acess√≠vel');
  }
  
  // Verificar conex√£o com a Evolution API
  try {
    console.log('\nüîÑ Verificando conex√£o com a Evolution API...');
    const evolutionStatus = await evolutionApiService.checkConnectionStatus();
    
    if (evolutionStatus && evolutionStatus.instance?.state === 'open') {
      console.log('‚úÖ Evolution API conectada com sucesso!');
      console.log(`‚Ä¢ Inst√¢ncia: ${process.env.WHATSAPP_INSTANCE}`);
      console.log(`‚Ä¢ Estado: ${evolutionStatus.instance.state}`);
      console.log(`‚Ä¢ URL da API: ${process.env.EVOLUTION_API_URL}`);
      
      // Adicionar detalhes do WhatsApp se dispon√≠veis
      if (evolutionStatus.instance.phone) {
        console.log(`‚Ä¢ N√∫mero conectado: ${evolutionStatus.instance.phone.number}`);
        console.log(`‚Ä¢ Nome do perfil: ${evolutionStatus.instance.phone.name || 'N√£o definido'}`);
      }
      
      // Verificar m√©tricas de envio de forma segura
      try {
        const metrics = await evolutionApiService.getMetrics().catch(err => {
          console.log('‚Ä¢ M√©tricas de envio n√£o dispon√≠veis - endpoint n√£o encontrado');
          return null; // Retorna null em vez de propagar o erro
        });
        
        if (metrics && metrics.success) {
          console.log(`‚Ä¢ Mensagens enviadas hoje: ${metrics.data.dailySent || 0}`);
          console.log(`‚Ä¢ Mensagens recebidas hoje: ${metrics.data.dailyReceived || 0}`);
        }
      } catch (err) {
        // J√° tratamos o erro acima, esse bloco √© apenas por seguran√ßa adicional
        console.log('‚Ä¢ M√©tricas de envio n√£o dispon√≠veis');
      }
    } else {
      console.log('‚ö†Ô∏è Evolution API conectada, mas n√£o autenticada no WhatsApp');
      console.log(`‚Ä¢ Estado: ${evolutionStatus?.instance?.state || 'desconhecido'}`);
      console.log('‚Ä¢ √â necess√°rio autenticar escaneando o QR code');
      console.log(`‚Ä¢ URL da API: ${process.env.EVOLUTION_API_URL}`);
      
      // Verificar se h√° QR Code dispon√≠vel
      try {
        const qrCode = await evolutionApiService.getQrCode();
        if (qrCode && qrCode.success) {
          console.log('‚Ä¢ QR Code dispon√≠vel para autentica√ß√£o');
          console.log(`‚Ä¢ URL para QR Code: ${process.env.EVOLUTION_API_URL}/instance/qr/${process.env.WHATSAPP_INSTANCE}`);
        }
      } catch (err) {
        console.log('‚Ä¢ QR Code n√£o dispon√≠vel no momento');
      }
    }
  } catch (error) {
    console.error('‚ùå Erro ao conectar com a Evolution API:');
    console.error(`‚Ä¢ ${error.message}`);
    console.error(`‚Ä¢ URL configurada: ${process.env.EVOLUTION_API_URL}`);
    console.error('‚Ä¢ Verifique se o servi√ßo est√° em execu√ß√£o e acess√≠vel');
    
    // Adicionar instru√ß√µes de diagn√≥stico
    console.error('\n‚Ä¢ DIAGN√ìSTICO:');
    console.error('  1. Verifique se a URL da API est√° correta no arquivo .env');
    console.error('  2. Confirme se a inst√¢ncia do WhatsApp existe e est√° corretamente nomeada');
    console.error('  3. Teste se a API est√° acess√≠vel executando: curl -X GET '+process.env.EVOLUTION_API_URL+'/instance/connectionState/'+process.env.WHATSAPP_INSTANCE);
  }
  
  // Verificar sistema de filas
  try {
    console.log('\nüîÑ Verificando sistema de filas...');
    
    // Verificar Redis primeiro
    console.log('‚Ä¢ Verificando conex√£o com Redis...');
    const redisEnabled = process.env.REDIS_ENABLED !== 'false';
    
    if (!redisEnabled) {
      console.log('‚ö†Ô∏è Redis est√° desativado no arquivo .env (REDIS_ENABLED=false)');
      console.log('‚Ä¢ O sistema usar√° modo de fallback (sem enfileiramento)');
    } else {
      const redisStatus = await checkRedisConnection();
      
      if (redisStatus.success) {
        console.log('‚úÖ Redis conectado com sucesso!');
        console.log(`‚Ä¢ Vers√£o: ${redisStatus.stats.version}`);
        console.log(`‚Ä¢ Uptime: ${redisStatus.stats.uptime}`);
        console.log(`‚Ä¢ Mem√≥ria em uso: ${redisStatus.stats.memory.used}`);
        console.log(`‚Ä¢ Clientes conectados: ${redisStatus.stats.clients}`);
      } else {
        console.error('‚ùå Falha na conex√£o com Redis:');
        console.error(`‚Ä¢ Erro: ${redisStatus.error}`);
        console.error(`‚Ä¢ Problema: ${redisStatus.diagnosis.problem}`);
        console.error('‚Ä¢ Poss√≠veis causas:');
        redisStatus.diagnosis.possibleCauses.forEach(cause => {
          console.error(`  - ${cause}`);
        });
        console.error('‚Ä¢ Sugest√µes:');
        redisStatus.diagnosis.suggestions.forEach(suggestion => {
          console.error(`  - ${suggestion}`);
        });
        console.log('‚Ä¢ O sistema usar√° modo de fallback (sem enfileiramento)');
      }
    }
    
    // Agora obter estat√≠sticas da fila
    const queueStats = await queueService.getQueueStats();
    
    if (queueStats.success) {
      if (queueStats.fallbackMode) {
        console.log('‚ö†Ô∏è Sistema de filas em modo de fallback (sem Redis)');
        console.log('‚Ä¢ As mensagens ser√£o enviadas diretamente sem enfileiramento');
        console.log('‚Ä¢ Sem limita√ß√£o de taxa ser√° aplicada');
      } else {
        console.log('‚úÖ Sistema de filas inicializado com sucesso!');
        console.log(`‚Ä¢ Concorr√™ncia: ${queueStats.config.concurrency} workers`);
        console.log(`‚Ä¢ Limite de mensagens: ${queueStats.config.messagesPerMinute}/minuto`);
        console.log(`‚Ä¢ Jobs na fila: ${queueStats.jobs.waiting} aguardando, ${queueStats.jobs.active} ativos`);
        
        // Adicionar informa√ß√µes da conex√£o Redis
        console.log(`‚Ä¢ Conex√£o Redis: ${process.env.REDIS_URL?.replace(/\/\/(.+?):(.+?)@/, '//***:***@') || process.env.REDIS_HOST || 'localhost:6379'}`);
        
        // Adicionar mais estat√≠sticas detalhadas de jobs
        if (queueStats.jobs.failed > 0) {
          console.log(`‚ö†Ô∏è Aten√ß√£o: ${queueStats.jobs.failed} jobs falharam recentemente`);
        }
        
        if (queueStats.jobs.delayed > 0) {
          console.log(`‚Ä¢ Jobs programados: ${queueStats.jobs.delayed}`);
        }
        
        if (queueStats.jobs.completed) {
          console.log(`‚Ä¢ Jobs processados: ${queueStats.jobs.completed} completados`);
        }
      }
    } else {
      console.log('‚ö†Ô∏è Sistema de filas inicializado com alertas');
      if (queueStats.message) {
        console.log(`‚Ä¢ Alerta: ${queueStats.message}`);
      }
    }
  } catch (error) {
    console.error('‚ùå Erro ao inicializar sistema de filas:');
    console.error(`‚Ä¢ ${error.message}`);
    console.error('‚Ä¢ Verifique se o Redis est√° em execu√ß√£o no endere√ßo configurado');
    console.error(`‚Ä¢ URL Redis: ${process.env.REDIS_URL?.replace(/\/\/(.+?):(.+?)@/, '//***:***@') || 'localhost:6379'}`);
    console.error('‚Ä¢ O sistema tentar√° operar sem o sistema de filas (modo fallback)');
  }
  
  // Informa√ß√µes sobre o agendador de campanhas
  const schedulerResult = require('./services/schedulerService').getStatus();
  if (schedulerResult && schedulerResult.isRunning) {
    console.log(`‚úÖ Agendador de campanhas iniciado com sucesso`);
    console.log(`‚Ä¢ Tipo: Agendadas e recorrentes`);
    console.log(`‚Ä¢ Intervalo de verifica√ß√£o: ${schedulerResult.checkInterval / 1000} segundos`);
    console.log(`‚Ä¢ Pr√≥xima verifica√ß√£o: ${schedulerResult.nextCheck.toLocaleString()}`);
  } else {
    console.error('‚ùå Agendador de campanhas n√£o est√° em execu√ß√£o');
    console.log('‚Ä¢ Inicie o agendador manualmente ou reinicie o servidor');
  }
  
  // Mostrar URLs da API
  console.log('\nüåê ENDPOINTS DISPON√çVEIS:');
  console.log(`‚Ä¢ API:            http://localhost:${PORT}/api`);
  console.log(`‚Ä¢ Documenta√ß√£o:   http://localhost:${PORT}/api-docs`);
  console.log(`‚Ä¢ Status da fila:  http://localhost:${PORT}/api/queue/stats`);
  console.log(`‚Ä¢ Status da inst√¢ncia: http://localhost:${PORT}/api/evolution/status`);
  console.log(`‚Ä¢ Contatos:       http://localhost:${PORT}/api/contacts`);
  console.log(`‚Ä¢ Campanhas:      http://localhost:${PORT}/api/campaigns`);
  console.log(`‚Ä¢ Mensagens:      http://localhost:${PORT}/api/messages`);
  console.log(`‚Ä¢ Segmenta√ß√£o:    http://localhost:${PORT}/api/segmentation`);
  
  // Listagem de recursos do sistema
  console.log('\nüìã RECURSOS DO SISTEMA:');
  console.log(`‚Ä¢ MongoDB: ${mongoose.connection.readyState === 1 ? '‚úÖ Conectado' : '‚ùå Desconectado'}`);
  console.log(`‚Ä¢ Evolution API: ${evolutionApiService.isConnected ? '‚úÖ Conectado' : '‚ùå Desconectado'}`);
  console.log(`‚Ä¢ Redis: ${queueService.queueEnabled ? '‚úÖ Ativo' : '‚ùå Inativo (fallback)'}`);
  console.log(`‚Ä¢ Agendador: ${require('./services/schedulerService').isRunning ? '‚úÖ Em execu√ß√£o' : '‚ùå Parado'}`);
  
  console.log('\n==================================================');
  console.log(`üöÄ Servidor rodando na porta ${PORT}`);
  console.log('==================================================\n');
}

// Iniciar o servidor
const server = app.listen(PORT, () => {
  console.log(`üöÄ Servidor rodando na porta ${PORT}`);
  
  // Inicializar Socket.IO
  socketService.initialize(server);
  
  // Verificar servi√ßos
  checkServices();
}); 